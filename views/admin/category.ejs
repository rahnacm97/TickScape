<%- include("../../views/partials/admin/header") %>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    .content-main {
      padding: 40px;
    }

    .content-header {
      margin-bottom: 30px;
    }

    .content-title {
      font-size: 32px;
      font-weight: 500;
      color: #333;
    }

    .card-header {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .input-group {
      width: 60%;
    }

    .form-control {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 30px;
      margin-right: 10px;
      font-size: 14px;
    }

    .btn {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 30px;
      cursor: pointer;
      border: none;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .table-responsive {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    .table th,
    .table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .table th {
      background-color: #f7f7f7;
      font-weight: 500;
    }

    .pagination-container {
      text-align: center;
      margin-top: 20px;
    }

    .pagination a,
    .pagination .current-page {
      padding: 8px 16px;
      margin: 0 4px;
      border-radius: 30px;
      text-decoration: none;
      background-color: #f0f0f0;
      color: #333;
      transition: background-color 0.3s ease;
    }

    .pagination a:hover {
      background-color: #007bff;
      color: white;
    }

    .pagination .current-page {
      background-color: #007bff;
      color: white;
    }

    .error-message {
      color: red;
      font-size: 12px;
    }

    .badge {
      padding: 5px 10px;
      border-radius: 30px;
      font-size: 14px;
    }

    .badge-success {
      background-color: #28a745;
      color: white;
    }

    .badge-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-info {
      background-color: #17a2b8;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 30px;
      color: white;
    }

    .btn-info:hover {
      background-color: #138496;
    }

    .btn-danger {
      background-color: #dc3545;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 30px;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-success {
      background-color: #28a745;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 30px;
      color: white;
    }

    .btn-success:hover {
      background-color: #218838;
    }
    .search-container {
      width: 100%;
      max-width: 1000px; 
      margin: 0 auto;
      padding: 20px 0;
    }

    .btn-add-category {
      width: 250px; 
      padding: 20px 50px; 
    }
  </style>
</head>
<body>
  <section class="content-main">
    <div class="content-header">
      <h2 class="content-title">Categories</h2>
    </div>
    <header class="card-header">
      <div class="search-container">
        <form action="/admin/category/" method="get" class="d-inline">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Search categories" name="search" value="<%= searchQuery %>"/>
            <button class="btn" type="submit">Search</button>
          </div>
        </form>
      </div>
      <a href="/admin/addCategory" class="btn btn-primary btn-add-category" data-section="category">Add Category</a>
    </header>

    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="text-center">Sl.No</th>
            <th>Name</th>
            <th>Description</th>
            <th>Offer Price</th>
            <th>Offer</th>
            <th>Status</th>
            <th>List/Unlist</th>
            <th class="text-center">Edit</th>
          </tr>
        </thead>
        <tbody>
          <% cat.reverse().forEach((category, index) => { %>
          <tr>
            <td class="text-center"><%= (currentPage - 1) * limit + index + 1 %></td>
            <td><%= category.name %></td>
            <td><%= category.description %></td>
            <td><%= category.categoryOffer ? category.categoryOffer + "%" : "0%" %></td>
            <td>
              <% if (category.categoryOffer === 0) { %>
              <button class="btn btn-info" style="width: 150px" onclick="addOffer('<%= category._id %>')">Add Offer</button>
              <% } else { %>
              <button class="btn btn-info" style="width: 150px" onclick="removeOffer('<%= category._id %>')">Remove Offer</button>
              <% } %>
            </td>
            <td>
              <% if (category.isListed) { %>
              <span class="badge badge-success">Listed</span>
              <% } else { %>
              <span class="badge badge-danger">Unlisted</span>
              <% } %>
            </td>
            <td>
              <% if (category.isListed) { %>
              <button class="btn btn-danger" onclick="confirmAction('<%= category._id %>', 'unlist')">Unlist</button>
              <% } else { %>
              <button class="btn btn-success" onclick="confirmAction('<%= category._id %>', 'list')">List</button>
              <% } %>
            </td>
            <td class="text-center">
              <a href="/admin/editCategory?id=<%= category._id %>" class="btn btn-info" data-section="category">Edit</a>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div class="pagination-container">
      <% if (currentPage > 1) { %>
      <a href="?page=<%= currentPage - 1 %>&search=<%= searchQuery %>">&laquo; Previous</a>
      <% } %>
      <% for (let i = 1; i <= totalPages; i++) { %>
      <% if (i === currentPage) { %>
      <span class="current-page"><%= i %></span>
      <% } else { %>
      <a href="?page=<%= i %>&search=<%= searchQuery %>"><%= i %></a>
      <% } %>
      <% } %>
      <% if (currentPage < totalPages) { %>
      <a href="?page=<%= currentPage + 1 %>&search=<%= searchQuery %>">Next &raquo;</a>
      <% } %>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    async function addOffer(categoryId) {
  const {value:amount} = await Swal.fire({
    title:"Offer in percentage",
    input:"number",
    inputLabel:"Percentage",
    inputPlaceholder:"%",
  });
  if(amount){
    try{
      const response = await fetch("/admin/addCategoryOffer",{
        method:"POST",
        headers:{
          'content-type':"application/json",
        },
        body:JSON.stringify({
          percentage:amount,
          categoryId:categoryId,
        }),
      });

      const data = await response.json();
      if(response.ok && data.status === true){
        Swal.fire(
          "Offer added",
          "The offer has been added",
          "Success"
        ).then(() => {
          location.reload();
        })
      }else{
        Swal.fire("Failed",data.message || "Adding offer failed","error");
      }
    }catch(error){
      Swal.fire(
        "Error",
        "An error occured while adding the offer",
        "error"
      );
      console.log("Error adding offer",error);
    }
  }
}

async function removeOffer(categoryId){
  try {
    const response = await fetch("/admin/removeCategoryOffer", {
      method:"POST",
      headers:{
        "content-type":"application/json",
      },
      body: JSON.stringify({
        categoryId:categoryId,
      })
    })
    const data = await response.json();

    if(response.ok && data.status === true){
      Swal.fire(
        "Offer removed",
        "The offer has been removed",
        "Success"
      ).then(() => {
        location.reload();
      });
    }else{
      Swal.fire("Failed",data.message || "Removing offer failed","error");
    }
  } catch (error) {
    Swal.fire(
      "Error",
      "An error occured while removing the offer",
      "error"
    );
    console.error("Error removing offer",error);
  }
}
  function confirmAction(categoryId, action) {
    let actionText = action === 'list' ? "List" : "Unlist";
    let actionUrl = action === 'list' ? `/admin/unlistCategory?id=${categoryId}` : `/admin/listCategory?id=${categoryId}`;

    Swal.fire({
      title: `Are you sure you want to ${actionText} this category?`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: `Yes, ${actionText} it!`
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = actionUrl;
      }
    });
  }

  </script>

<%- include("../../views/partials/admin/footer") %>
