
<%- include("../../views/partials/admin/header") %>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f5f7;
      }
      
  
      .content-main {
        padding: 20px;
      }
  
      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
  
      .content-title {
        font-size: 32px;
        font-weight: 700;
        color: #333;
      }
  
      .card-header {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
  
      .search-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
  
      .input-group {
        display: flex;
        flex: 1;
        margin-right: 10px;
      }
  
      .form-control {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
  
      .btn {
        padding: 10px 20px;
      font-size: 12px;
      border-radius: 30px;
        background-color: #007bff;
        color: #fff;
        padding: 10px 15px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
  
      .btn:hover {
        background-color: #0056b3;
      }

      .search-container {
      width: 100%;
      max-width: 1000px; 
      margin: 0 auto;
      padding: 20px 0;
    }
  
      .btn-primary {
        margin-left: 10px;
      }
  
      .table-responsive {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
      }
  
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
  
      .table th,
      .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
  
      .table th {
        background-color: #f8f9fa;
        font-weight: 500;
      }
  
      .pagination-container {
      text-align: center;
      margin-top: 20px;
    }

    .pagination a,
    .pagination .current-page {
      padding: 8px 16px;
      margin: 0 4px;
      border-radius: 30px;
      text-decoration: none;
      background-color: #f0f0f0;
      color: #333;
      transition: background-color 0.3s ease;
    }

    .pagination a:hover {
      background-color: #007bff;
      color: white;
    }

    .pagination .current-page {
      background-color: #007bff;
      color: white;
    }
  
      .btn-danger {
        background-color: #dc3545;
      }
  
      .btn-info {
        background-color: #17a2b8;
      }
    </style>
  </head>
  <body>
    <section class="content-main">
      <div class="content-header">
        <h2 class="content-title">Products</h2>
      </div>
      <header class="card-header">
        <div class="search-container">
          <form action="/admin/products/" method="get" class="d-inline">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search product" name="search" value="<%= searchQuery %>" style="border-top-left-radius: 25px; border-bottom-left-radius: 25px;"/>
              <button class="btn" type="submit">Search</button>
            </div>
          </form>
          <a href="/admin/addProducts" class="btn btn-primary btn-add-category" data-section="products">Add Product +</a>
        </div>
      </header>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th class="text-center">Sl. No</th>
              <th>Product Name</th>
              <th>Brand</th>
              <th>Category</th>
              <th>Sale Price</th>
              <th>Offer ₹</th>
              <th>Offer</th>
              <th>Quantity</th>
              <th>Status</th>
              <th>Action</th>
              <th class="text-center">Edit</th>
            </tr>
          </thead>
          <tbody>
            
            <% data.reverse().forEach((product,index) => { %>
            <tr>
              <td class="text-center"><%= (currentPage - 1) * limit + index + 1 %></td>
              <td><%= product.productName %></td>
              <td><%= product.brand ? product.brand.brandName : "No Brand" %></td>
              <td><%= product.category.name %></td>
              <td>₹<%= product.salePrice %></td>
              <td><%= product.productOffer ? product.productOffer + "" : "0" %></td>
              <td>
                <% if (product.productOffer) { %>
                  <button class="btn btn-info" onclick="removeOffer('<%= product._id %>')">Remove Offer</button>
                <% } else { %>
                  <button class="btn btn-info" onclick="addOffer('<%= product._id %>')">Add Offer</button>
                <% } %>
              </td>
              <td><%= product.quantity %></td>
              <td>
                <% if (product.isBlocked === false) { %>
                <button class="btn btn-danger" style="width: 80px;" onclick="confirmProductAction('<%= product._id %>', 'block')">
                  Block
                </button>
                <% } else { %>
                <button class="btn btn-success" style="width: 80px;" onclick="confirmProductAction('<%= product._id %>', 'unblock')">
                  Unblock
                </button>
                <% } %>
              </td>
              <td>
                <button class="btn btn-danger" onclick="return confirmDelete()"><a href="/admin/deleteProduct?id= <%= product._id %>" class="text-white fas fa-trash"></a></button>
              </td>

              <td class="text-center">
                <a href="/admin/editProduct/<%= product._id %>" class="btn btn-info fas fa-edit" data-section="products"></a>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <div class="pagination-container">
        <% if (currentPage > 1) { %>
        <a href="?page=<%= currentPage - 1 %>&search=<%= searchQuery %>">&laquo; Previous</a>
        <% } %>
        <% for (let i = 1; i <= totalPages; i++) { %>
        <% if (i === currentPage) { %>
        <span class="current-page"><%= i %></span>
        <% } else { %>
        <a href="?page=<%= i %>&search=<%= searchQuery %>"><%= i %></a>
        <% } %>
        <% } %>
        <% if (currentPage < totalPages) { %>
        <a href="?page=<%= currentPage + 1 %>&search=<%= searchQuery %>">Next &raquo;</a>
        <% } %>
      </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  </body>
  
 

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
  //   async function addOffer(productId){
  //       const {value:percentage} = await Swal.fire({
  //           title:'Offer in Percentage',
  //           input:'number',
  //           inputLabel:'percentage',
  //           inputPlaceholder:'%'
  //       })
  //       if (percentage) {
  //           $.ajax({
  //           url:"/admin/addProductOffer",
  //           method:'post',
  //           data:{
  //               percentage:percentage,
  //               productId:productId
  //           },
  //           success:(response)=>{
  //               if(response.status===true){
  //                   location.reload()
  //                   Swal.fire('Offer Added',"The Offer has been removed",'Success');
  //               }else{
  //                   alert("Failed");
  //               }
  //           }
  //       })
  //   console.log('Amount entered:', amount);
  // } else {
  //   console.log('No value entered or the modal was closed');
  // }
  //       console.log(amount,"This is the amount");
      
  //   }

    function removeOffer(productId){
        try {
            Swal.fire({
                title:'Remove Offer',
                text:'Do you want to remove this offer?',
                icon:'warning',
                showCancelButton:true,
                cancelButtonColor:'d33',
                confirmButtonText:'Yes, remove it.',
                timer:5000,
                timerProgessBar:true
            }).then(async (result) =>{
                if(result.isConfirmed){
                    $.ajax({
                        url:"/admin/removeProductOffer",
                        method:'post',
                        data:{
                            productId:productId
                        },
                        success:(response) => {
                            if(response.status===true){
                                Swal.fire('Removed','The offer has been removed','Success');
                                location.reload();
                            }else if(response.status === false){
                                Swal.fire('failed');
                            }else{
                                alert('Failed');
                            }
                        }
                    })
                }
            })
        } catch (error) {
            console.error(error);
        }
    }

  async function addOffer(productId) {
    const { value: offerAmount } = await Swal.fire({
        title: 'Offer Amount',
        input: 'number',
        inputLabel: 'Enter discount amount',
        inputPlaceholder: 'Amount'
    });

    if (offerAmount) {
        const amount = parseFloat(offerAmount);

        if (isNaN(amount) || amount <= 0) {
            Swal.fire('Invalid Input', 'Please enter a valid positive number for the discount amount.', 'error');
            return;
        }

        $.ajax({
            url: "/admin/addProductOffer",
            method: 'post',
            data: {
                offerAmount: amount, // Now sending amount instead of percentage
                productId: productId
            },
            success: (response) => {
                if (response.status === true) {
                    Swal.fire('Offer Added', "The Offer has been applied successfully.", 'success');
                    location.reload();
                } else {
                    Swal.fire('Failed', response.message || "Something went wrong.", 'error');
                }
            },
            error: () => {
                Swal.fire('Error', 'Could not connect to the server.', 'error');
            }
        });

        console.log('Amount entered:', amount);
    } else {
        console.log('No value entered or the modal was closed');
    }
}

    function confirmDelete(){
        return confirm("Are you sure, you want to delete this product?");
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmProductAction(productId, action) {
    let actionText = action === 'block' ? "Block" : "Unblock";
    let actionUrl = action === 'block' ? `/admin/blockProduct?id=${productId}` : `/admin/unblockProduct?id=${productId}`;

    Swal.fire({
      title: `Are you sure you want to ${actionText} this product?`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: `Yes, ${actionText} it!`
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = actionUrl;
      }
    });
  }
</script>

<%- include("../../views/partials/admin/footer") %>
