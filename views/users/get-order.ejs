<%- include("../../views/partials/user/header") %>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f1f3f6; 
    padding: 0;
  }

  .main {
    padding: 20px 0;
  }

  .page-header.breadcrumb-wrap {
    background-color: #fff;
    padding: 10px 0;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
  }

  .breadcrumb a {
    color: #2874f0;
    text-decoration: none;
    font-weight: 500;
  }

  .breadcrumb span {
    margin: 0 5px;
    color: #878787;
  }

  .section-title {
    font-size: 38px;
    font-weight: 600;
    color: #212121;
    margin-bottom: 20px;
    text-align: left;
  }

  .main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 15px;
    background: #fff;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
  }


  .sidebar {
    background: #fff;
    padding: 20px;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
  }

  .sidebar .profile-summary {
    text-align: center;
    margin-bottom: 20px;
  }

  .sidebar .profile-summary .avatar-placeholder {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
  }

  .sidebar .profile-summary .fas.fa-user {
    font-size: 40px;
    color: #6c757d;
  }

  .sidebar .profile-summary h5 {
    font-size: 18px;
    color: #212121;
    margin-bottom: 5px;
  }

  .sidebar .profile-summary p {
    font-size: 14px;
    color: #878787;
  }

  .sidebar .nav-link {
    color: #212121;
    padding: 10px 15px;
    font-size: 16px;
    border-radius: 2px;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .sidebar .nav-link:hover,
  .sidebar .nav-link.active {
    background-color: #5695fa;
    color: #fff;
  }

  .sidebar .nav-link i {
    margin-right: 10px;
  }

  .sidebar .nav-link .badge {
    background-color:rgb(30, 116, 187); 
    color: #fff;
  }


  .order-card {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    margin-bottom: 15px;
    padding: 15px;
    background-color: #fff;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .order-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }

  .img-fluid {
    height: 60px;
    width: 60px;
    border-radius: 4px;
    object-fit: cover;
    margin-right: 8px;
    border: 1px solid #eee;
  }

  .card-body {
    padding: 0;
  }

  .order-id {
    font-weight: 600;
    color: #212121;
    font-size: 16px;
    margin-bottom: 5px;
  }

  .card-text {
    margin: 3px 0;
    color: #555;
    font-size: 14px;
  }

  .text-success {
    color: #28a745; 
    font-weight: 600;
  }

  .text-danger {
    color: #ff6161; 
    font-weight: 600;
  }

  .text-pending {
    color: #ff9800; 
    font-weight: 600;
  }

  .btn-small1 {
    background-color: #1b69e6;; 
    color: #fff;
    padding: 6px 15px;
    border-radius: 2px;
    font-size: 13px;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.2s ease;
    border: none;
  }

  .btn-small1:hover {
    background-color: #014bba;
    color: #fff;
  }

  .empty-orders {
    text-align: center;
    padding: 40px;
    color: #878787;
    background: #fff;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
  }

  .empty-orders .btn-small1 {
    margin-top: 15px;
  }


  .pagination {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin: 20px 0;
  }

  .pagination a {
    padding: 6px 12px;
    background-color: #fff;
    border: 1px solid #e0e0e0;
    color: #2874f0;
    text-decoration: none;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .pagination a:hover {
    background-color: #2874f0;
    color: #fff;
    border-color: #2874f0;
  }

  .pagination .active {
    background-color: #2874f0;
    color: #fff;
    border-color: #2874f0;
  }

  @media (max-width: 991px) {
    .sidebar {
      margin-bottom: 20px;
    }
    .main-container {
      padding: 10px;
    }
  }

  @media (max-width: 768px) {
    .order-card {
      padding: 10px;
    }
    .img-fluid {
      height: 50px;
      width: 50px;
    }
    .order-id {
      font-size: 14px;
    }
    .card-text {
      font-size: 12px;
    }
    .btn-small1 {
      padding: 5px 12px;
      font-size: 12px;
    }
    .sidebar .profile-summary .avatar-placeholder {
      width: 60px;
      height: 60px;
    }
    .sidebar .profile-summary .fas.fa-user {
      font-size: 30px;
    }
    .sidebar .nav-link {
      font-size: 14px;
    }
  }
</style>

<main class="main">
  <div class="page-header breadcrumb-wrap">
    <div class="container">
      <div class="breadcrumb">
        <a href="/" rel="nofollow">Home</a>
        <span></span><a href="/userProfile" rel="nofollow">Profile</a>
        <span></span>Orders
      </div>
    </div>
  </div>

  <section>
    <div class="container">
      <h3 class="section-title mt-5">My Orders</h3>
      <div class="row g-4">
       
        <div class="col-lg-3 col-md-12">
          <div class="sidebar">
            <div class="profile-summary">
              <div class="avatar-placeholder">
                <i class="fas fa-user"></i>
              </div>
              <h5><%= user.fname || 'User Name' %> <%= user.lname || '' %></h5>
              <p><%= user.email || 'user@example.com' %></p>
            </div>
            <nav class="nav flex-column">
              <a class="nav-link" href="/userProfile"><i class="fas fa-user"></i> Profile</a>
              <a class="nav-link active" href="/orders"><i class="fas fa-shopping-bag"></i> Orders</a>
              <a class="nav-link" href="/address"><i class="fas fa-map-marker-alt"></i> Addresses</a>
              <a class="nav-link" href="/wishlist">
                <i class="fas fa-heart"></i> Wishlist
                <% if (user.wishlist && user.wishlist.length > 0) { %>
                  <span class="badge bg-teal rounded-pill ms-2"><%= user.wishlist.length %></span>
                <% } %>
              </a>
              <a class="nav-link" href="/cart">
                <i class="fas fa-shopping-cart"></i> Cart
                <% if (cartItemCount > 0) { %>
                  <span class="badge bg-teal rounded-pill ms-2"><%= cartItemCount %></span>
                <% } %>
              </a>
            </nav>
          </div>
        </div>

        <div class="col-lg-9 col-md-12">
          <div class="main-container">
            <% if (orders && orders.length > 0) { %>
              <div id="orders-container">
                <% orders.forEach((order) => { %>
                  <div class="order-card">
                    <div class="row g-0 align-items-center">
                      <div class="col-md-2">
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                          <% order.orderedItems.forEach((product, index) => { %>
                            <% if (index < 3) { %>
                              <img src="<%= product && product.image && product.image.length > 0 ? product.image[0] : '/default-image.jpg' %>" 
                                   class="img-fluid" alt="Product Image">
                            <% } %>
                          <% }) %>
                          <% if (order.orderedItems.length > 3) { %>
                            <div style="display: flex; align-items: center; font-size: 12px; color: #777;">
                              +<%= order.orderedItems.length - 3 %> more
                            </div>
                          <% } %>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card-body">
                          <p class="order-id">Order #<%= order.orderId %></p>
                          <p class="card-text">Items: <%= order.orderedItems.length %></p>
                          <p class="card-text">Payment: <%= order.paymentMethod %></p>
                          <p class="card-text">Amount: â‚¹<%= (order.finalAmount).toFixed(2) %></p>
                        </div>
                      </div>
                      <div class="col-md-4 text-end" style="display: flex; flex-direction: column; justify-content: center; align-items: flex-end; gap: 5px;">
                        <p class="card-text">
                          <% if (order.status === 'Cancelled') { %>
                            <span class="text-danger"><strong>Cancelled</strong></span>
                          <% } else if (order.status === 'Payment Pending') { %>
                            <span class="text-pending"><strong>Pending</strong></span>
                          <% } else { %>
                            <span class="text-success"><strong><%= order.status %></strong></span>
                          <% } %>
                        </p>
                        <% if (order.status === 'Cancelled') { %>
                          <p class="text-danger" style="font-size: 12px;">
                            <strong>Cancelled on <%= new Date(order.invoiceDate).toDateString() %></strong>
                          </p>
                        <% } %>
                        <a href="/viewOrder/<%= order.orderid %>" class="btn-small1">View Order</a>
                      </div>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <div class="empty-orders">
                <p>You don't have any orders yet.</p>
                <a href="/shop" class="btn-small1">Continue Shopping</a>
              </div>
            <% } %>

            <div id="pagination-container" class="pagination">
              <% if (currentPage > 1) { %>
                <a href="#" data-page="<%= currentPage - 1 %>" class="pagination-link">Prev</a>
              <% } %>
              <% for (let i = 1; i <= totalPages; i++) { %>
                <a href="#" data-page="<%= i %>" class="pagination-link <%= i === currentPage ? 'active' : '' %>">
                  <%= i %>
                </a>
              <% } %>
              <% if (currentPage < totalPages) { %>
                <a href="#" data-page="<%= currentPage + 1 %>" class="pagination-link">Next</a>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const paginationLinks = document.querySelectorAll('.pagination-link');

    paginationLinks.forEach(link => {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        const page = this.getAttribute('data-page');
        loadOrders(page);
      });
    });

    function loadOrders(page) {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `/orders?page=${page}`, true);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.onload = function() {
        if (xhr.status === 200) {
          const response = JSON.parse(xhr.responseText);
          updateOrders(response.orders);
          updatePagination(response.currentPage, response.totalPages);
        } else {
          console.error('Error loading orders');
        }
      };
      xhr.send();
    }

    function updateOrders(orders) {
      const ordersContainer = document.getElementById('orders-container');
      ordersContainer.innerHTML = '';

      if (orders && orders.length > 0) {
        orders.forEach(order => {
          let productImagesHTML = '';
          const maxImagesToShow = 3;

          order.orderedItems.forEach((product, index) => {
            if (index < maxImagesToShow) {
              productImagesHTML += `
                <img src="${product.image && product.image[0] ? product.image[0] : '/default-image.jpg'}"
                     class="img-fluid" alt="Product Image">`;
            }
          });

          if (order.orderedItems.length > maxImagesToShow) {
            productImagesHTML += `
              <div style="display: flex; align-items: center; font-size: 12px; color: #777;">
                +${order.orderedItems.length - maxImagesToShow} more
              </div>`;
          }

          let orderHTML = `
            <div class="order-card">
              <div class="row g-0 align-items-center">
                <div class="col-md-2">
                  <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    ${productImagesHTML}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card-body">
                    <p class="order-id">Order #${order.orderId}</p>
                    <p class="card-text">Items: ${order.orderedItems.length}</p>
                    <p class="card-text">Payment: ${order.paymentMethod}</p>
                    <p class="card-text">Amount: â‚¹${parseFloat(order.finalAmount).toFixed(2)}</p>
                  </div>
                </div>
                <div class="col-md-4 text-end" style="display: flex; flex-direction: column; justify-content: center; align-items: flex-end; gap: 5px;">
                  <p class="card-text">
                    ${order.status === 'Cancelled' ? 
                      `<span class="text-danger"><strong>Cancelled</strong></span>` : 
                      order.status === 'Payment Pending' ?
                      `<span class="text-pending"><strong>Pending</strong></span>` :
                      `<span class="text-success"><strong>${order.status}</strong></span>`}
                  </p>
                  ${order.status === 'Cancelled' ? 
                    `<p class="text-danger" style="font-size: 12px;">
                      <strong>Cancelled on ${new Date(order.invoiceDate).toDateString()}</strong>
                    </p>` : ''}
                  <a href="/viewOrder/${order.orderid}" class="btn-small1">View Order</a>
                </div>
              </div>
            </div>`;
          ordersContainer.innerHTML += orderHTML;
        });
      } else {
        ordersContainer.innerHTML = `
          <div class="empty-orders">
            <p>You don't have any orders yet.</p>
            <a href="/shop" class="btn-small1">Continue Shopping</a>
          </div>`;
      }
    }

    function updatePagination(currentPage, totalPages) {
      const paginationContainer = document.querySelector('.pagination');
      paginationContainer.innerHTML = '';

      if (currentPage > 1) {
        const prevLink = document.createElement('a');
        prevLink.href = '#';
        prevLink.setAttribute('data-page', currentPage - 1);
        prevLink.className = 'pagination-link';
        prevLink.textContent = 'Prev';
        paginationContainer.appendChild(prevLink);
      }

      for (let i = 1; i <= totalPages; i++) {
        const pageLink = document.createElement('a');
        pageLink.href = '#';
        pageLink.setAttribute('data-page', i);
        pageLink.className = `pagination-link ${i === currentPage ? 'active' : ''}`;
        pageLink.textContent = i;
        paginationContainer.appendChild(pageLink);
      }

      if (currentPage < totalPages) {
        const nextLink = document.createElement('a');
        nextLink.href = '#';
        nextLink.setAttribute('data-page', currentPage + 1);
        nextLink.className = 'pagination-link';
        nextLink.textContent = 'Next';
        paginationContainer.appendChild(nextLink);
      }

      const newPaginationLinks = document.querySelectorAll('.pagination-link');
      newPaginationLinks.forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const page = this.getAttribute('data-page');
          loadOrders(page);
        });
      });
    }
  });
</script>

<%- include("../../views/partials/user/footer") %>