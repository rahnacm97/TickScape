<%- include("../../views/partials/user/header") %>
<style>
.products {
    border: 2px solid #ddd; 
    border-radius: 10px; 
    padding: 20px; 
    margin-top: 20px;
    background-color: #f9f9f9;
}
.address {
    border: 2px solid #ddd; 
    border-radius: 10px; 
    padding: 20px; 
    margin-top: 20px;
    background-color: #f9f9f9; 
}

.payments{
    margin-left: 20%;
    width:60%;
    border: 2px solid #ddd; 
    border-radius: 10px; 
    padding: 20px; 
    margin-top: 20px;
    background-color: #f9f9f9; 
}
.page-header.breadcrumb-wrap {
    margin-top: 10px;
    background-color: #ede9ec;
    padding: 10px 0;
}

.breadcrumb-wrap {
    padding: 15px 0;
    background-color: #1e918b;
    color: #fff;
}

.breadcrumb a {
    color: #088178;
    text-decoration: none;
}

.breadcrumb span {
    margin: 0 5px;
    color: rgb(125, 124, 124);
}
/* General Styling */

.order_review {
    margin-bottom: 30px;
}

.table th, .table td {
    text-align: center;
}

.table-responsive {
    margin-bottom: 20px;
}

.card {
    margin-bottom: 20px;
    border-radius: 8px;
}

.card-body {
    padding: 20px;
}

.card-header {
    background-color: #f7f7f7;
    padding: 10px;
}

.coupon-card {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.coupon-name {
    font-weight: bold;
}

.coupon-card button {
    margin-top: 10px;
}

.payment_method {
    margin-top: 20px;
}

.custom-radio {
    margin-bottom: 20px;
}

.custom-radio input {
    margin-right: 10px;
}

.custom-radio label {
    font-weight: bold;
}

.table th {
    background-color: #d5d0d0;
}

input[type="text"], .form-check-label {
    font-size: 14px;
    color: #333;
}

.btn-small {
    font-size: 12px;
}

.btn-primary {
    background-color: #066e2c;
    border-color: #076338;
    width: 150px; /* Adjust width as needed */
   
}

input[type="text"] {
    border: 1px solid #5c88b4;
    border-radius: 5px;
}

.product-subtotal {
    font-size: 20px;
    font-weight: bold;
}

.use-button {
    background-color: #048923;
    color: white;
}

.cancel-button {
    background-color: #dc3545;
    color: white;
}

.table td, .table th {
    vertical-align: middle;
}

    .coupon-card {
        border: 2px solid #eaeaea;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .coupon-name {
        font-size: 12px;
        font-weight: bold;
    }

    .use-button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .use-button:hover {
        background-color: #45a049;
    }
</style>
    <section>
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> <a href="/shop" rel="nofollow">Shop</a>
                    <span></span> <a href="/cart" rel="nofollow">Cart</a>
                    <span></span> Check Out
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="row">
                    <div class="col-md-12 products">
                        <div class="mb-20">
                            <h3>Products</h3>
                        </div>
                        <div class="card">
                            <div class="table-responsive order_table text-center">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Sl. No</th>
                                            <th>Image</th>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Product Total</th>
                                            <!-- <th>Delete</th> -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (carts && carts.items && carts.items.length > 0) { %>
                                            <% carts.items.forEach((item,index) => { %>
                                                <tr>
                                                    <td><%= index + 1 %></td>
                                                    <td scope="row">
                                                        <div class="d-flex align-items-center mt-2">
                                                            <img src="<%= item.productId.productImage[0] %>" class="img-fluid rounded-circle" style="width: 90px; height: 90px;" alt="">
                                                        </div>
                                                    </td>
                                                    <td class="py-5"><%=item.productId.productName%></td>
                                                    <td class="py-5">$<%= item.price.toFixed(2) %></td>
                                                    <td class="py-5"><%= item.quantity %></td>
                                                    <td class="py-5">$<%= item.totalPrice.toFixed(2) %></td>
                                                    
                                                    <!-- <td class="action" data-title="Remove" onclick="return confirm('Are you sure you want remove this product from cart?')">
                                                        <a class="btn btn-sm"
                                                            href="">
                                                            <i class="fi-rs-trash"></i>
                                                        </a>

                                                    </td> -->
                                                    <td><input type="hidden" id="productid" value="<%=item.productId._id%>"></td>
                                                    
                                                </tr>
                                                
                                                <% }); %>
                                                <% } else { %>
                                                        <tr>
                                                            <td colspan="4">No products found</td>
                                                        </tr>
                                                <% } %>  
                                                <tr>
                                                    
                                                    <td colspan="5" class="py-1">
                                                        <p class="mb-0 text-dark py-1">Total</p>
                                                    </td>
                                                    <td class="py-1">
                                                        
                                                            <p class="mb-0 text-dark"> $<%= total %></p>
                                                    
                                                    </td>
                                                </tr>   
                                                <tr>
                                                    
                                                    <td class="py-1 w-100 " colspan = "5" >
                                                        <p class="mb-0 text-dark py-1">Shipping Charge </p>
                                                    </td>
                                                    <td colspan=""><p class="mb-0 text-dark py-1">$50</p></td>
                                                    
                                                </tr>
                                                <tr>
                                                    <td class="py-1" colspan="5">
                                                        <p class="mb-0 text-dark py-1">Discount</p>
                                                    </td>
                                                    <td colspan="" id="discount">
                                                        <p class="mb-0 text-dark py-1">$20</p>
                                                    </td>
                                                    
                                                 </tr>
                                                <tr>
                                                    
                                                    <td class="py-1" colspan="5">
                                                        <p class="mb-0 text-dark text-uppercase py-1">Sub Total</p>
                                                    </td>
                                                    <td colspan="">
                                                        <div class="py-1 border-bottom border-top">
                                                        <p class="mb-0 text-dark">$<%= total + 50 - 20 %></p>
                                                        </div>
                                                    </td>
                                                        
                                                    </td>
                                                </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 container address">
                        <div class="mb-20">
                            <h3>Addresses</h3>
                        </div>
                        <div class="row align-items-start">
                            <% if (address.length > 0) { %>
                                <% address.forEach(function (userAddress) { %>
                                    <% userAddress.address.forEach(function (addr) { %>
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio"
                                                        id="addressRadio<%= addr._id %>" name="selectedAddress"
                                                        value="<%= addr._id %>">
                                                </div>
                            
                                                <div class="card-header">
                                                    <h5 class="mb-0">
                                                        <%= addr.addressType %>
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <address>
                                                        <%= addr.name %>, <br>
                                                        <%= addr.city %>,
                                                        <%= addr.landMark %>,
                                                        <%= addr.state %>,
                                                    </address>
                                                    <p><%= addr.pincode %>,
                                                    <%= addr.phone %>,
                                                    <%= addr.altPhone%></p>
                            
                                                    <div class="d-flex justify-content-between">
                                                        <a href="/editAddress?id=<%= addr._id %>"
                                                            class="btn-small">Edit</a>
                                                        <a href="/deleteAddress?id=<%= addr._id %>"
                                                            class="btn-small" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% }) %>
                            <% } else { %>
                                <div class="col-lg-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0"></h5>
                                        </div>
                                        <div class="card-body">
                                            <address>No address</address>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                            
                            <div class="col-lg-6 mb-3">
                                <a href="/addAddress">
                                    <button class="btn btn-primary w-50 " style="margin-left: 400px;">Add address</button>
                                </a>
                            </div>
                                
                            </div>

                        </div>
                    </div>
                    <div class="payments">
                        <div class="mb-20">
                            <h3>Payment Methods</h3>
                        </div>
                        <div class="payment_method col-6">   
                            <input type="radio" class="form-check-input" id="Onlinepayment" name="paymentMethod" value="Online Payment">
                            <label class="form-check-label" for="Onlinepayment">Online Payment(via Razorpay)</label><br>
                            
                            <input type="radio" class="form-check-input" id="paymentMethodCOD" name="paymentMethod" value="Cash on Delivery">
                            <label class="form-check-label" for="paymentMethodCOD">Cash on Delivery</label> <br>
                            
                            <input type="radio" class="form-check-input" id="paymentWallet" name="paymentMethod" value="Wallet">
                            <label class="form-check-label" for="paymentWallet">Wallet</label><br>

                            <input type="radio" class="form-check-input" id="creditCard" name="paymentMethod" value="Credit">
                            <label class="form-check-label" for="paymentWallet">Credit Card</label><br>

                            <input type="radio" class="form-check-input" id="banktransfer" name="paymentMethod" value="Bank">
                            <label class="form-check-label" for="paymentWallet">Bank Transfer</label><br>

                        </div>
                    </div>

                    <div class="container col-6 mt-3"> 
                        <div class="ml-150">
                    
                            <div class="ml-65">
                                
                                    <button type="button" class="btn" id="placeorder" onclick="placeOrder('')">Place Order</button>
                               
                            </div>
                           
                        </div>
                    </div>
                </div>
            </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
function placeOrder() {
    // Extract Cart Items
    let orderedItems = [];
    document.querySelectorAll("tbody tr").forEach(row => {
        let productId = row.querySelector("#productid")?.value; // Get product ID
        let quantity = row.cells[4]?.textContent; // Quantity column
        let price = row.cells[3]?.textContent.replace("$", ""); // Price column
        let productTotal = row.cells[5]?.textContent.replace("$", "");

        if (productId) {
            orderedItems.push({
                product: productId,  // ✅ Match Schema Field
                quantity: parseInt(quantity),
                price: parseFloat(price),
                totalPrice: parseFloat(productTotal) // ✅ Ensure total price is sent
            });
        }
    });

    // Check if there are any products in the cart
    if (orderedItems.length === 0) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Your cart is empty!',
        });
        return;
    }

    // Extract Address
    let selectedAddress = document.querySelector('input[name="selectedAddress"]:checked')?.value;
    if (!selectedAddress) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select an address!',
        });
        return;
    }

    // Extract Payment Method
    let paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    if (!paymentMethod) {
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Please select a payment method!',
        });
        return;
    }

    // Calculate Total Price
    let totalPrice = orderedItems.reduce((sum, item) => sum + item.totalPrice, 0);
    let shipping = 50;
    let discount = 20;
    let finalAmount = totalPrice + shipping - discount;

    // Send Order Request
    fetch("/placeOrder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            orderedItems,
            totalPrice, 
            discount,
            shipping,
            finalAmount,
            address: selectedAddress,
            status: "Processing",
            paymentMethod: paymentMethod
        })
    })
    .then(response => response.json())
    .then(response => {
        console.log(response,'response');
        localStorage.setItem('orders',JSON.stringify(response.orders))
        
        if (response.success) {
            Swal.fire({
                icon: 'success',
                title: 'Order Placed!',
                text: 'Your order has been successfully placed.',
            }).then(() => {
                const orders = JSON.parse(localStorage.getItem('orders'));
                if (orders) {
                const encodedOrders = encodeURIComponent(JSON.stringify(orders));
                window.location.href = `/orderDetails?orders=${encodedOrders}`;
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'There was an issue placing your order.',
            });
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong. Please try again later.',
        });
    });
}

</script>

<%- include("../../views/partials/user/footer") %>

