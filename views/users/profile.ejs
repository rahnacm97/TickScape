<%- include("../../views/partials/user/header") %>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
  :root {
    --primary-color: #108af4;
    --secondary-color: #4a5568;
    --light-color: #f7fafc;
    --dark-color: #2d3748;
    --success-color: #2e6c81;
    --danger-color: #e53e3e;
    --border-radius: 0.5rem;
    --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
    color: var(--dark-color);
  }
  
  .page-header.breadcrumb-wrap {
    background-color: #fff;
    padding: 10px 0;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
  }

  .breadcrumb a {
    color: #2874f0;
    text-decoration: none;
    font-weight: 500;
  }

  .breadcrumb span {
    margin: 0 5px;
    color: #878787;
  }
  
  .dashboard-menu {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 2rem;
  }
  
  .dashboard-menu .nav-item {
    border-bottom: 1px solid #edf2f7;
  }
  
  .dashboard-menu .nav-item:last-child {
    border-bottom: none;
  }
  
  .dashboard-menu .nav-link {
    color: var(--secondary-color);
    padding: 1rem 1.5rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
  }
  
  .dashboard-menu .nav-link i {
    margin-right: 0.75rem;
    font-size: 1.1rem;
    width: 24px;
    text-align: center;
  }
  
  .dashboard-menu .nav-link.active,
  .dashboard-menu .nav-link:hover {
    color: var(--primary-color);
    background-color: rgba(56, 178, 172, 0.05);
    border-left: 3px solid var(--primary-color);
  }
  
  .card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 2rem;
    overflow: hidden;
  }
  
  .card-header {
    background-color: white;
    border-bottom: 1px solid #edf2f7;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .card-green .card-header {
    background-color: rgba(56, 178, 172, 0.1);
  }
  
  .card-body {
    padding: 2rem;
  }
  
  .btn-success {
    background-color: var(--success-color);
    border-color: var(--success-color);
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }
  
  .btn-success:hover {
    background-color: #38a169;
    border-color: #38a169;
  }
  
  .credit {
    color: var(--success-color) !important;
    font-weight: bold;
  }
  
  .debit {
    color: var(--danger-color) !important;
    font-weight: bold;
  }
  
  .table {
    border-collapse: separate;
    border-spacing: 0 0.5rem;
  }
  
  .table thead th {
    border-top: none;
    border-bottom: 1px solid #edf2f7;
    padding: 0.75rem;
    color: var(--secondary-color);
    font-weight: 600;
  }
  
  .table tbody tr {
    background-color: white;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius);
  }
  
  .table tbody td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border: none;
  }
  
  .referral-code-container {
    background-color: white !important;
    border: 1px dashed var(--primary-color) !important;
  }
  
  .earnings-container {
    background-color: var(--success-color) !important;
  }
  
  @media (max-width: 768px) {
    .dashboard-menu {
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .card-header a {
      margin-left: 0 !important;
      margin-top: 0.5rem;
    }
  }

  .bg-gradient-primary {
                  background: linear-gradient(45deg, var(--primary-color), var(--primary-color-dark, #0056b3));
                }
                
                .wallet-balance {
                  transition: all 0.3s ease;
                  overflow: hidden;
                }
                
                .wallet-balance:hover {
                  transform: translateY(-5px);
                  box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
                }
                
                .shine-effect {
                  position: absolute;
                  top: 0;
                  left: -100%;
                  width: 50%;
                  height: 100%;
                  background: linear-gradient(
                    to right,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    rgba(255, 255, 255, 0) 100%
                  );
                  transform: skewX(-25deg);
                  animation: shine 3s infinite;
                }
                
                @keyframes shine {
                  0% { left: -100%; }
                  20% { left: 100%; }
                  100% { left: 100%; }
                }
</style>
</head>
<body>
<main class="main">
  <div class="page-header breadcrumb-wrap mb-3 mt-3">
    <div class="container">
      <div class="breadcrumb">
        <a href="/" rel="nofollow">Home</a>
        <span></span> Profile 
      </div>
    </div>
  </div>
  <section class="pt-4 pb-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-12 m-auto">
          <div class="row">
            <div class="col-md-4">
              <div class="dashboard-menu ms-1">
                <ul class="nav flex-column" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                      <i class="fi-rs-settings-sliders"></i>Dashboard
                    </a>
                  </li>
                  <li class="nav-item">
                   <a class="nav-link" href="/address">
                      <i class="fi-rs-marker"></i>My Address
                    </a>
                  </li>
                  <li class="nav-item">
                   <a class="nav-link" href="/orders">
                       <i class="fi-rs-shopping-bag"></i>Orders
                   </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fas fa-wallet"></i>Wallet Status
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fas fa-history"></i> Wallet History
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fas fa-user-friends"></i> Referrals
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/logout">
                      <i class="fi-rs-sign-out"></i>Logout
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-md-8">
              <div class="tab-content dashboard-content">
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                  <div class="card card-green">
                    <div class="card-header">
                      <h5 class="mb-0">My Profile</h5>
                      <a href="javascript:void(0);" onclick="confirmEdit('<%= user._id %>')" class="text-primary">
                        <i class="fas fa-edit me-1"></i>Edit
                      </a>
                    </div>
                    <div class="card-body text-center">
                      <div class="mb-4">
                        <div class="avatar-placeholder mb-3" style="width: 100px; height: 100px; border-radius: 50%; background-color: #e2e8f0; display: inline-flex; align-items: center; justify-content: center;">
                          <i class="fas fa-user" style="font-size: 40px; color: #a0aec0;"></i>
                        </div>
                        <h4 class="card-title"><%= user.fname %> <%= user.lname %></h4>
                      </div>
                      <div class="user-info mb-4">
                        <p class="card-text mb-3">
                          <i class="fas fa-phone-alt me-2" style="color: var(--primary-color);"></i>
                          <strong>Phone: </strong><%= user.phone %>
                        </p>
                        <p class="card-text mb-4">
                          <i class="fas fa-envelope me-2" style="color: var(--primary-color);"></i>
                          <strong>Email: </strong><%= user.email %>
                        </p>
                      </div>
                      <div class="d-flex justify-content-center gap-3">
                        <a href="/change-email" class="btn btn-success" style="text-transform: capitalize;">
                          <i class="fas fa-envelope me-1"></i> Change Email
                        </a>
                        <a href="/change-password" class="btn btn-success" style="text-transform: capitalize;">
                          <i class="fas fa-lock me-1"></i> Change Password
                        </a>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
                    <div class="card-header bg-gradient-primary text-white py-3">
                      <h5 class="mb-0 fw-bold"><i class="fas fa-wallet me-2"></i>My Wallet</h5>
                    </div>
                    <div class="card-body contact-from-area p-4">
                      <div class="row">
                        <div class="col-lg-8 mx-auto my-4">
                          <div class="wallet-balance p-4 mb-4 rounded-4 shadow-sm position-relative" 
                               style="background: linear-gradient(135deg, #f8f9fa 0%, #e2e8f0 100%); border: 1px solid #e2e8f0;">
                            <div class="row align-items-center">
                              <div class="col-md-3 text-center mb-3 mb-md-0">
                                <img src="\assets\img\logo\wallet_6445868.png" alt="Wallet Icon" class="img-fluid" 
                                     style="max-width: 100px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                              </div>
                              <div class="col-md-9">
                                <p class="text-secondary mb-1 fw-light">Current Balance</p>
                                <div class="balance-amount mb-2" 
                                     style="font-size: 1.8rem; font-weight: 800; background: linear-gradient(to right, var(--primary-color), var(--secondary-color, #6c757d)); background-clip: text; -webkit-text-fill-color: transparent;">
                                  ₹<%= user.wallet.reduce((sum, entry) => sum + entry.amount, 0).toFixed(2); %>
                                </div>
                              </div>
                            </div>
                            
                            <div class="shine-effect"></div>
                          </div>
                          <a href="/add-money" class="btn px-4 py-2 mt-2 rounded-pill shadow-sm" 
                            style="background: linear-gradient(to right, var(--primary-color), var(--secondary-color, #6c757d)); color: white; border: none; margin-left: 150px;"
                            data-bs-toggle="modal" data-bs-target="#addMoneyModal">
                            <i class="fas fa-plus-circle me-2"></i>Add Money
                          </a>

                          <div class="modal fade" id="addMoneyModal" tabindex="-1" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                              <div class="modal-content">
                                <div class="modal-header">
                                  <h5 class="modal-title" id="addMoneyModalLabel">Add Money to Wallet</h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                  <form id="addMoneyForm">
                                    <div class="mb-3">
                                      <label for="amountInput" class="form-label">Enter Amount (₹)</label>
                                      <input type="number" class="form-control" id="amountInput" 
                                             min="1" step="0.01" required placeholder="Enter amount">
                                    </div>
                                    <div class="text-muted small">Minimum amount: ₹1</div>
                                  </form>
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                  <button type="button" class="btn btn-primary" id="proceedPayment">Proceed to Pay</button>
                                </div>
                              </div>
                            </div>
                          </div>


                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                

                <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="orders-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Wallet History</h5>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Reason</th>
                              <th>Status</th>
                              <th>Amount</th>
                            </tr>
                          </thead>
                          <tbody id="wallet-history-tbody">
                            <% walletHistory.forEach(entry => { %>
                              <tr>
                                <td><%= new Date(entry.date).toDateString() %></td>
                                <td><%= entry.reason %></td>
                                <td>
                                  <% if (entry.amount > 0) { %>
                                    <span class="badge bg-success">Credit</span>
                                  <% } else { %>
                                    <span class="badge bg-danger">Debit</span>
                                  <% } %>
                                </td>
                                <td class="<%= entry.amount > 0 ? 'credit' : 'debit' %>">
                                  <%= entry.amount > 0 ? '₹' + entry.amount : '-₹' + Math.abs(entry.amount) %>
                                </td>
                              </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                      <nav aria-label="Wallet History Pagination" style="margin-top: 40px;">
                        <ul class="pagination justify-content-center" id="wallet-pagination">
                          <% if (currentPage > 1) { %>
                            <li class="page-item">
                              <a class="page-link" href="#" data-page="<%= currentPage - 1 %>" aria-label="Previous">
                                <span aria-hidden="true">«</span>
                              </a>
                            </li>
                          <% } %>
                          <% for (let i = 1; i <= totalPages; i++) { %>
                            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                              <a class="page-link" href="#" data-page="<%= i %>"><%= i %></a>
                            </li>
                          <% } %>
                          <% if (currentPage < totalPages) { %>
                            <li class="page-item">
                              <a class="page-link" href="#" data-page="<%= currentPage + 1 %>" aria-label="Next">
                                <span aria-hidden="true">»</span>
                              </a>
                            </li>
                          <% } %>
                        </ul>
                      </nav>
                    </div>
                  </div>
                </div>              

                <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header" style="background-color: var(--primary-color); color: white;">
                     <h5 class="mb-0">Refer & Earn</h5>
                   </div>
                   <div class="card-body p-4">
                     <div class="text-center mb-4">
                       <img src="\assets\img\logo\3775975.jpg" alt="Referral Illustration" class="img-fluid mb-3" style="max-width: 150px;">
                       <h5 class="mb-3">Invite Friends & Earn Rewards</h5>
                       <p class="text-muted">Share your referral link with friends and earn when they join!</p>
                     </div>
                     
                     <div class="referral-code-container p-3 my-4 rounded">
                       <p class="mb-2 fw-bold">Your Referral Link:</p>
                       <div class="input-group">
                         <input type="text" class="form-control" value="<%= user.referalCode %>" readonly>
                         <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('<%= user.referalCode %>')">
                           <i class="fas fa-copy me-1"></i> Copy
                         </button>
                       </div>
                     </div>
                     
                     <div class="earnings-container p-4 text-white rounded d-flex align-items-center justify-content-center">
                       <!-- <div>
                         <p class="mb-1">Total Earnings</p>
                         <h4 class="mb-0 fw-bold">₹<%= user.wallet.reduce((sum, entry) => sum + entry.amount, 0) %></h4>
                       </div> -->
                       <div class="referral-icon">
                         <i class="fas fa-gift" style="font-size: 2rem;"></i>
                       </div>
                     </div>
                     
                     <div class="mt-4 text-center">
                       <div class="row justify-content-center">
                         <div class="col-md-8">
                           <div class="d-flex justify-content-center gap-2">
                             <button class="btn btn-outline-primary" type="button">
                               <i class="fab fa-facebook"></i>
                             </button>
                             <button class="btn btn-outline-primary" type="button">
                               <i class="fab fa-twitter"></i>
                             </button>
                             <button class="btn btn-outline-primary" type="button">
                               <i class="fab fa-whatsapp"></i>
                             </button>
                             <button class="btn btn-outline-primary" type="button">
                               <i class="fas fa-envelope"></i>
                             </button>
                           </div>
                         </div>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get the current URL hash (e.g., #wallet-history)
    let activeTab = window.location.hash;
    
    // If there's a hash, activate the corresponding tab
    if (activeTab) {
      let tabElement = document.querySelector(`a[href="${activeTab}"]`);
      if (tabElement) {
        new bootstrap.Tab(tabElement).show();
      }
    }
  });
</script>

<script>
    function confirmEdit(userId) {
        Swal.fire({
            title: "Are you sure?",
            text: "Do you want to edit your profile?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, go to edit!",
            cancelButtonText: "Cancel"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/edit-profile?id=${userId}`;
            }
        });
    }



    document.addEventListener('DOMContentLoaded', () => {
    const paginationLinks = document.querySelectorAll('#wallet-pagination .page-link');
    const tbody = document.querySelector('#wallet-history-tbody');
    const pagination = document.querySelector('#wallet-pagination');

    paginationLinks.forEach(link => {
      link.addEventListener('click', async (e) => {
        e.preventDefault(); // Prevent page reload
        const page = link.getAttribute('data-page');

        try {
          const response = await fetch(`/wallet-history?page=${page}`);
          const data = await response.json();

          // Update table body
          tbody.innerHTML = data.walletHistory.map(entry => `
            <tr>
              <td>${new Date(entry.date).toDateString()}</td>
              <td>${ entry.reason }</td>
              <td>
                ${entry.amount > 0 
                  ? '<span class="badge bg-success">Credit</span>' 
                  : '<span class="badge bg-danger">Debit</span>'}
              </td>
              <td class="${entry.amount > 0 ? 'credit' : 'debit'}">
                ${entry.amount > 0 ? '₹' + entry.amount : '-₹' + Math.abs(entry.amount)}
              </td>
            </tr>
          `).join('');

          // Update pagination
          pagination.innerHTML = generatePagination(data.currentPage, data.totalPages);
          
          // Re-attach event listeners to new pagination links
          attachPaginationListeners();
        } catch (error) {
          console.error('Error fetching wallet history:', error);
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Failed to load wallet history!',
          });
        }
      });
    });

    // Function to generate pagination HTML
    function generatePagination(currentPage, totalPages) {
      let html = '';
      if (currentPage > 1) {
        html += `
          <li class="page-item">
            <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
              <span aria-hidden="true">«</span>
            </a>
          </li>
        `;
      }
      for (let i = 1; i <= totalPages; i++) {
        html += `
          <li class="page-item ${currentPage === i ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>
        `;
      }
      if (currentPage < totalPages) {
        html += `
          <li class="page-item">
            <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
              <span aria-hidden="true">»</span>
            </a>
          </li>
        `;
      }
      return html;
    }

    // Function to re-attach event listeners to new pagination links
    function attachPaginationListeners() {
      const newPaginationLinks = document.querySelectorAll('#wallet-pagination .page-link');
      newPaginationLinks.forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault();
          const page = link.getAttribute('data-page');

          try {
            const response = await fetch(`/wallet-history?page=${page}`);
            const data = await response.json();

            tbody.innerHTML = data.walletHistory.map(entry => `
              <tr>
                <td>${new Date(entry.date).toDateString()}</td>
                 <td>${ entry.reason }</td>
                <td>
                  ${entry.amount > 0 
                    ? '<span class="badge bg-success">Credit</span>' 
                    : '<span class="badge bg-danger">Debit</span>'}
                </td>
                <td class="${entry.amount > 0 ? 'credit' : 'debit'}">
                  ${entry.amount > 0 ? '₹' + entry.amount : '-₹' + Math.abs(entry.amount)}
                </td>
              </tr>
            `).join('');

            pagination.innerHTML = generatePagination(data.currentPage, data.totalPages);
            attachPaginationListeners(); // Re-attach listeners again
          } catch (error) {
            console.error('Error fetching wallet history:', error);
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'Failed to load wallet history!',
            });
          }
        });
      });
    }
  });

  function copyToClipboard(text) {
        navigator.clipboard.writeText(text)
            .then(() => {
                alert("Referral code copied to clipboard: " + text);
            })
            .catch(err => {
                console.error("Failed to copy: ", err);
                alert("Failed to copy referral code.");
            });
    }


    document.getElementById('proceedPayment').addEventListener('click', async function () {
    const amount = document.getElementById('amountInput').value;

    console.log("Amount", amount);

    try {
        // First, fetch user data from the server
        const userResponse = await fetch('/get-user-profile', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const userData = await userResponse.json();

        const orderResponse = await fetch('/add-money', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ amount: amount }),
        });
        const order = await orderResponse.json();
        
        console.log("Order", order);

        const options = {
            key: 'rzp_test_YFWFrvVk0xexkK',
            amount: order.amount,
            currency: order.currency,
            name: "TickScape",
            description: "Wallet Top-up",
            order_id: order.id,
            handler: async function (response) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Payment Successful!',
                    text: 'Your payment has been processed successfully.',
                    confirmButtonColor: '#3085d6',
                });

                const verifyResponse = await fetch('/verify-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature,
                        amount: amount,
                    }),
                });
                const data = await verifyResponse.json();

                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Wallet Updated!',
                        text: 'Your wallet has been updated successfully.',
                        confirmButtonColor: '#3085d6',
                    });
                    window.location.reload();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Verification Failed',
                        text: 'Payment verification failed. Please contact support.',
                        confirmButtonColor: '#d33',
                    });
                }
            },
            prefill: {
                name: "TickScape",
                email: "tickscapeSupport@gmail.com",
                contact: "+91 7034316981",
            },
            theme: {
                color: "#3399cc"
            }
        };

        const rzp = new Razorpay(options);
        rzp.open();

    } catch (error) {
        await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong. Please try again.',
            confirmButtonColor: '#d33',
        });
        console.error('Error:', error);
    }
});
  
</script>
<%- include("../../views/partials/user/footer") %>
